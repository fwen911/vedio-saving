<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é™åˆ¶æ¬¡æ•°è§†é¢‘åˆ†äº«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
            padding: 40px 0;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        main {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .upload-section {
            margin-bottom: 40px;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px 40px;
            text-align: center;
            background: #f8f9ff;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f2ff;
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            border-color: #764ba2;
            background: #e8ebff;
        }

        .upload-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.7;
        }

        .upload-area h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #333;
        }

        .upload-area p {
            color: #666;
            margin-bottom: 20px;
        }

        .upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .upload-progress {
            margin-top: 20px;
        }

        .progress-bar {
            background: #e0e7ff;
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            color: #666;
            font-size: 0.9rem;
        }

        .share-section {
            background: #f8fff8;
            border: 2px solid #4caf50;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .share-result h3 {
            color: #4caf50;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .share-link {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }

        .share-link input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e7ff;
            border-radius: 8px;
            font-size: 0.9rem;
            background: #f8f9ff;
        }

        .copy-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            background: #45a049;
            transform: translateY(-1px);
        }

        .video-preview {
            margin-top: 20px;
            text-align: center;
        }

        .video-preview video {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .info-section {
            background: #fff8e1;
            border-radius: 15px;
            padding: 25px;
        }

        .info-section h3 {
            color: #ff9800;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .info-section ul {
            list-style: none;
            padding-left: 0;
        }

        .info-section li {
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
            color: #666;
        }

        .info-section li:before {
            content: "âœ“";
            position: absolute;
            left: 0;
            color: #4caf50;
            font-weight: bold;
        }

        footer {
            text-align: center;
            color: white;
            opacity: 0.8;
            padding: 20px 0;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #c62828;
        }

        .success-message {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #2e7d32;
        }

        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            header h1 {
                font-size: 2rem;
            }
            
            main {
                padding: 20px;
            }
            
            .upload-area {
                padding: 40px 20px;
            }
            
            .share-link {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“¹ é™åˆ¶æ¬¡æ•°è§†é¢‘åˆ†äº«</h1>
            <p>ä¸Šä¼ è§†é¢‘ï¼Œç”Ÿæˆåˆ†äº«é“¾æ¥ï¼Œæ’­æ”¾5æ¬¡åè‡ªåŠ¨åˆ é™¤</p>
        </header>

        <main>
            <!-- ä¸Šä¼ åŒºåŸŸ -->
            <section class="upload-section">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-content">
                        <div class="upload-icon">ğŸ“¤</div>
                        <h3>æ‹–æ‹½æˆ–ç‚¹å‡»ä¸Šä¼ è§†é¢‘</h3>
                        <p>æ”¯æŒ MP4, WebM, OGV æ ¼å¼ï¼Œæœ€å¤§ 100MB</p>
                        <input type="file" id="videoFile" accept="video/*" style="display: none;">
                        <button class="upload-btn" onclick="document.getElementById('videoFile').click()">é€‰æ‹©æ–‡ä»¶</button>
                    </div>
                </div>
                
                <div class="upload-progress" id="uploadProgress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <p class="progress-text" id="progressText">ä¸Šä¼ ä¸­... 0%</p>
                </div>
            </section>

            <!-- åˆ†äº«é“¾æ¥åŒºåŸŸ -->
            <section class="share-section" id="shareSection" style="display: none;">
                <div class="share-result">
                    <h3>âœ… ä¸Šä¼ æˆåŠŸï¼</h3>
                    <p>åˆ†äº«é“¾æ¥ï¼ˆæ’­æ”¾5æ¬¡åè‡ªåŠ¨åˆ é™¤ï¼‰ï¼š</p>
                    <div class="share-link">
                        <input type="text" id="shareLink" readonly>
                        <button class="copy-btn" onclick="copyShareLink()">å¤åˆ¶é“¾æ¥</button>
                    </div>
                    <div class="video-preview">
                        <video id="previewVideo" controls></video>
                    </div>
                </div>
            </section>

            <!-- è¯´æ˜åŒºåŸŸ -->
            <section class="info-section">
                <h3>ğŸ“ ä½¿ç”¨è¯´æ˜</h3>
                <ul>
                    <li>ä¸Šä¼ è§†é¢‘æ–‡ä»¶ï¼Œè‡ªåŠ¨ç”Ÿæˆåˆ†äº«é“¾æ¥</li>
                    <li>ä»»ä½•äººé€šè¿‡é“¾æ¥éƒ½å¯ä»¥è§‚çœ‹è§†é¢‘</li>
                    <li>è§†é¢‘åªèƒ½æ’­æ”¾5æ¬¡ï¼Œè¾¾åˆ°æ¬¡æ•°åè‡ªåŠ¨åˆ é™¤</li>
                    <li>è§†é¢‘æ–‡ä»¶æœ€å¤§æ”¯æŒ100MB</li>
                    <li>ä¸Šä¼ åè¯·ç«‹å³ä¿å­˜åˆ†äº«é“¾æ¥</li>
                </ul>
            </section>
        </main>

        <footer>
            <p>Â© 2024 é™åˆ¶æ¬¡æ•°è§†é¢‘åˆ†äº« - ä¿æŠ¤éšç§ï¼Œå®‰å…¨åˆ†äº«</p>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // å…¨å±€å˜é‡
        let supabase;
        let currentVideoId;

        // åˆå§‹åŒ– Supabase
        function initSupabase() {
            // è¿™é‡Œä½¿ç”¨å…¬å…±çš„ Supabase é¡¹ç›®é…ç½®
            // æ³¨æ„ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä½ åº”è¯¥ä½¿ç”¨è‡ªå·±çš„ Supabase é¡¹ç›®
            const supabaseUrl = 'https://your-project.supabase.co';
            const supabaseKey = 'your-anon-key';
            
            supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initSupabase();
            setupEventListeners();
            checkShareLink();
        });

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            const uploadArea = document.getElementById('uploadArea');
            const videoFile = document.getElementById('videoFile');

            // æ–‡ä»¶é€‰æ‹©
            videoFile.addEventListener('change', handleFileSelect);

            // æ‹–æ‹½ä¸Šä¼ 
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);
        }

        // æ£€æŸ¥æ˜¯å¦æ˜¯åˆ†äº«é“¾æ¥é¡µé¢
        function checkShareLink() {
            const urlParams = new URLSearchParams(window.location.search);
            const videoId = urlParams.get('video');
            
            if (videoId) {
                // å¦‚æœæ˜¯åˆ†äº«é“¾æ¥ï¼Œæ˜¾ç¤ºæ’­æ”¾é¡µé¢
                showVideoPlayer(videoId);
            }
        }

        // æ˜¾ç¤ºè§†é¢‘æ’­æ”¾é¡µé¢
        function showVideoPlayer(videoId) {
            document.querySelector('.upload-section').style.display = 'none';
            document.querySelector('.info-section').style.display = 'none';
            
            const playerSection = document.createElement('section');
            playerSection.className = 'player-section';
            playerSection.innerHTML = `
                <div class="player-container">
                    <h2>ğŸ¬ è§†é¢‘æ’­æ”¾</h2>
                    <div class="play-counter">
                        <p>å‰©ä½™æ’­æ”¾æ¬¡æ•°ï¼š<span id="playCount">åŠ è½½ä¸­...</span></p>
                    </div>
                    <video id="shareVideo" controls style="width: 100%; max-width: 800px;"></video>
                    <div class="player-info">
                        <p>âš ï¸ æ³¨æ„ï¼šæ’­æ”¾5æ¬¡åè§†é¢‘å°†è‡ªåŠ¨åˆ é™¤</p>
                    </div>
                </div>
            `;
            
            document.querySelector('main').insertBefore(playerSection, document.querySelector('footer'));
            
            loadSharedVideo(videoId);
        }

        // åŠ è½½åˆ†äº«çš„è§†é¢‘
        async function loadSharedVideo(videoId) {
            try {
                // è¿™é‡Œåº”è¯¥è°ƒç”¨ Supabase è·å–è§†é¢‘ä¿¡æ¯
                // ç”±äºæˆ‘ä»¬æ²¡æœ‰çœŸå®çš„ Supabase é…ç½®ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                const mockVideoData = {
                    url: 'https://sample-videos.com/zip/10/mp4/SampleVideo_1280x720_1mb.mp4',
                    playCount: 3,
                    maxPlays: 5
                };

                const video = document.getElementById('shareVideo');
                const playCountSpan = document.getElementById('playCount');
                
                video.src = mockVideoData.url;
                playCountSpan.textContent = `${mockVideoData.playCount}/${mockVideoData.maxPlays}`;

                // ç›‘å¬æ’­æ”¾äº‹ä»¶
                video.addEventListener('play', function() {
                    incrementPlayCount(videoId);
                });

            } catch (error) {
                console.error('åŠ è½½è§†é¢‘å¤±è´¥:', error);
                alert('è§†é¢‘åŠ è½½å¤±è´¥ï¼Œå¯èƒ½å·²è¢«åˆ é™¤æˆ–é“¾æ¥æ— æ•ˆ');
            }
        }

        // å¢åŠ æ’­æ”¾æ¬¡æ•°
        async function incrementPlayCount(videoId) {
            try {
                // è¿™é‡Œåº”è¯¥è°ƒç”¨ Supabase æ›´æ–°æ’­æ”¾æ¬¡æ•°
                console.log('å¢åŠ æ’­æ”¾æ¬¡æ•°:', videoId);
                
                // æ¨¡æ‹Ÿæ’­æ”¾æ¬¡æ•°å¢åŠ 
                setTimeout(() => {
                    const playCountSpan = document.getElementById('playCount');
                    const [current, max] = playCountSpan.textContent.split('/').map(Number);
                    const newCount = current - 1;
                    
                    if (newCount <= 0) {
                        alert('âš ï¸ æ’­æ”¾æ¬¡æ•°å·²è¾¾ä¸Šé™ï¼Œè§†é¢‘å°†è¢«åˆ é™¤');
                        // åˆ é™¤è§†é¢‘
                        setTimeout(() => {
                            window.location.href = window.location.pathname;
                        }, 3000);
                    } else {
                        playCountSpan.textContent = `${newCount}/${max}`;
                    }
                }, 1000);

            } catch (error) {
                console.error('æ›´æ–°æ’­æ”¾æ¬¡æ•°å¤±è´¥:', error);
            }
        }

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                uploadVideo(file);
            }
        }

        // å¤„ç†æ‹–æ‹½æ‚¬åœ
        function handleDragOver(e) {
            e.preventDefault();
            document.getElementById('uploadArea').classList.add('dragover');
        }

        // å¤„ç†æ‹–æ‹½ç¦»å¼€
        function handleDragLeave(e) {
            e.preventDefault();
            document.getElementById('uploadArea').classList.remove('dragover');
        }

        // å¤„ç†æ‹–æ‹½æ”¾ä¸‹
        function handleDrop(e) {
            e.preventDefault();
            document.getElementById('uploadArea').classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                uploadVideo(files[0]);
            }
        }

        // ä¸Šä¼ è§†é¢‘
        async function uploadVideo(file) {
            // éªŒè¯æ–‡ä»¶
            if (!file.type.startsWith('video/')) {
                alert('è¯·é€‰æ‹©è§†é¢‘æ–‡ä»¶');
                return;
            }

            if (file.size > 100 * 1024 * 1024) {
                alert('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡100MB');
                return;
            }

            // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
            document.getElementById('uploadProgress').style.display = 'block';
            
            try {
                // æ¨¡æ‹Ÿä¸Šä¼ è¿‡ç¨‹
                await simulateUpload(file);
                
                // ç”Ÿæˆåˆ†äº«é“¾æ¥
                const videoId = generateVideoId();
                const shareLink = `${window.location.origin}${window.location.pathname}?video=${videoId}`;
                
                // æ˜¾ç¤ºç»“æœ
                document.getElementById('shareLink').value = shareLink;
                document.getElementById('previewVideo').src = URL.createObjectURL(file);
                document.getElementById('shareSection').style.display = 'block';
                
                // éšè—ä¸Šä¼ è¿›åº¦
                document.getElementById('uploadProgress').style.display = 'none';
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆæ¨¡æ‹Ÿæ•°æ®åº“ï¼‰
                saveVideoInfo(videoId, file.name, file.size);
                
            } catch (error) {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                alert('ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•');
                document.getElementById('uploadProgress').style.display = 'none';
            }
        }

        // æ¨¡æ‹Ÿä¸Šä¼ è¿‡ç¨‹
        function simulateUpload(file) {
            return new Promise((resolve) => {
                let progress = 0;
                const interval = setInterval(() => {
                    progress += Math.random() * 20;
                    if (progress >= 100) {
                        progress = 100;
                        clearInterval(interval);
                        setTimeout(resolve, 500);
                    }
                    
                    document.getElementById('progressFill').style.width = progress + '%';
                    document.getElementById('progressText').textContent = `ä¸Šä¼ ä¸­... ${Math.round(progress)}%`;
                }, 200);
            });
        }

        // ç”Ÿæˆè§†é¢‘ID
        function generateVideoId() {
            return 'video_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // ä¿å­˜è§†é¢‘ä¿¡æ¯åˆ°æœ¬åœ°å­˜å‚¨
        function saveVideoInfo(videoId, fileName, fileSize) {
            const videoInfo = {
                id: videoId,
                name: fileName,
                size: fileSize,
                uploadTime: new Date().toISOString(),
                playCount: 0,
                maxPlays: 5,
                url: URL.createObjectURL(document.getElementById('videoFile').files[0])
            };
            
            // ä¿å­˜åˆ° localStorageï¼ˆå®é™…é¡¹ç›®ä¸­åº”è¯¥ä¿å­˜åˆ°æ•°æ®åº“ï¼‰
            const videos = JSON.parse(localStorage.getItem('videos') || '[]');
            videos.push(videoInfo);
            localStorage.setItem('videos', JSON.stringify(videos));
        }

        // å¤åˆ¶åˆ†äº«é“¾æ¥
        function copyShareLink() {
            const shareLink = document.getElementById('shareLink');
            shareLink.select();
            document.execCommand('copy');
            
            // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
            const copyBtn = document.querySelector('.copy-btn');
            const originalText = copyBtn.textContent;
            copyBtn.textContent = 'å·²å¤åˆ¶ï¼';
            copyBtn.style.background = '#4caf50';
            
            setTimeout(() => {
                copyBtn.textContent = originalText;
                copyBtn.style.background = '#4caf50';
            }, 2000);
        }

        // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
        window.addEventListener('beforeunload', function() {
            const videos = JSON.parse(localStorage.getItem('videos') || '[]');
            videos.forEach(video => {
                if (video.url && video.url.startsWith('blob:')) {
                    URL.revokeObjectURL(video.url);
                }
            });
        });
    </script>
</body>
</html>